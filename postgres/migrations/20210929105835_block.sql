-- Add migration script here
CREATE TABLE IF NOT EXISTS block (
    version integer NOT NULL REFERENCES metadata (version),

    block_num integer CHECK (block_num >= 0) NOT NULL,
    block_hash bytea NOT NULL,
    parent_hash bytea NOT NULL,
    state_root bytea NOT NULL,
    extrinsics_root bytea NOT NULL,
    digest bytea NOT NULL,
    extrinsics bytea[] NOT NULL,

    justifications bytea[],

    PRIMARY KEY (block_num)
) PARTITION BY RANGE (block_num);

-- Need to add a new child table when block_num is larger.
CREATE TABLE IF NOT EXISTS block_0 PARTITION OF block FOR VALUES FROM (0) TO (1000000);
CREATE TABLE IF NOT EXISTS block_1 PARTITION OF block FOR VALUES FROM (1000000) TO (2000000);
CREATE TABLE IF NOT EXISTS block_2 PARTITION OF block FOR VALUES FROM (2000000) TO (3000000);
CREATE TABLE IF NOT EXISTS block_3 PARTITION OF block FOR VALUES FROM (3000000) TO (4000000);
CREATE TABLE IF NOT EXISTS block_4 PARTITION OF block FOR VALUES FROM (4000000) TO (5000000);
CREATE TABLE IF NOT EXISTS block_5 PARTITION OF block FOR VALUES FROM (5000000) TO (6000000);
CREATE TABLE IF NOT EXISTS block_6 PARTITION OF block FOR VALUES FROM (6000000) TO (7000000);
CREATE TABLE IF NOT EXISTS block_7 PARTITION OF block FOR VALUES FROM (7000000) TO (8000000);
CREATE TABLE IF NOT EXISTS block_8 PARTITION OF block FOR VALUES FROM (8000000) TO (9000000);
CREATE TABLE IF NOT EXISTS block_9 PARTITION OF block FOR VALUES FROM (9000000) TO (10000000);
CREATE TABLE IF NOT EXISTS block_10 PARTITION OF block FOR VALUES FROM (10000000) TO (11000000);
CREATE TABLE IF NOT EXISTS block_11 PARTITION OF block FOR VALUES FROM (11000000) TO (12000000);
CREATE TABLE IF NOT EXISTS block_12 PARTITION OF block FOR VALUES FROM (12000000) TO (13000000);
CREATE TABLE IF NOT EXISTS block_13 PARTITION OF block FOR VALUES FROM (13000000) TO (14000000);
CREATE TABLE IF NOT EXISTS block_14 PARTITION OF block FOR VALUES FROM (14000000) TO (15000000);
CREATE TABLE IF NOT EXISTS block_15 PARTITION OF block FOR VALUES FROM (15000000) TO (16000000);
CREATE TABLE IF NOT EXISTS block_16 PARTITION OF block FOR VALUES FROM (16000000) TO (17000000);
CREATE TABLE IF NOT EXISTS block_17 PARTITION OF block FOR VALUES FROM (17000000) TO (18000000);
CREATE TABLE IF NOT EXISTS block_18 PARTITION OF block FOR VALUES FROM (18000000) TO (19000000);
CREATE TABLE IF NOT EXISTS block_19 PARTITION OF block FOR VALUES FROM (19000000) TO (20000000);

CREATE TABLE IF NOT EXISTS best_block (
    only_one boolean PRIMARY KEY DEFAULT TRUE,

    block_num integer CHECK (block_num >= 0) NOT NULL,
    block_hash bytea NOT NULL,

    CONSTRAINT only_one_row CHECK (only_one)
);

CREATE TABLE IF NOT EXISTS finalized_block (
    only_one boolean PRIMARY KEY DEFAULT TRUE,

    block_num integer CHECK (block_num >= 0) NOT NULL,
    block_hash bytea NOT NULL,

    CONSTRAINT only_one_row CHECK (only_one)
);
